<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My To-do List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fff; color: #333; }
        .sidebar-item.active { background-color: #f5f5f5; color: #5c67f2; font-weight: 600; }
        /* Tr·∫°ng th√°i m·∫∑c ƒë·ªãnh c·ªßa thanh nh·∫≠p li·ªáu */
.input-container {
    background-color: #f4f4f4; /* X√°m x·ªãt l√∫c ƒë·∫ßu */
    border: 1px solid transparent;
    transition: all 0.2s ease-in-out; /* Gi√∫p chuy·ªÉn m√†u m∆∞·ª£t m√† h∆°n */
}

/* Tr·∫°ng th√°i khi click v√†o (Focus) */
.input-container:focus-within {
    background-color: #ffffff !important; /* Chuy·ªÉn th√†nh n·ªÅn tr·∫Øng */
    border-color: #5c67f2; /* Vi·ªÅn xanh d∆∞∆°ng nh·∫π (m√†u TickTick) */
    box-shadow: 0 0 0 2px rgba(92, 103, 242, 0.1); /* Th√™m ƒë·ªï b√≥ng xanh c·ª±c nh·∫π */
}
        /* Checkbox Custom */
        .cb-custom {
            appearance: none;
            width: 18px; height: 18px;
            border-radius: 4px;
            border: 2px solid;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            background: white;
        }
        .cb-p1 { border-color: #ff4d4f; } /* High */
        .cb-p2 { border-color: #faad14; } /* Medium */
        .cb-p3 { border-color: #1890ff; } /* Low */
        .cb-p4 { border-color: #d1d1d1; } /* None */

        .cb-custom:checked {
            background-color: #d1d1d1 !important;
            border-color: #d1d1d1 !important;
        }
        .cb-custom:checked::after {
            content: '‚úì'; color: white; font-size: 11px;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }

        .task-text.completed { color: #afafaf; }
        .completed-section-header { cursor: pointer; user-select: none; }
    </style>
</head>
<body class="flex min-h-screen">

    <aside class="w-64 bg-[#fafafa] border-r border-gray-100 flex flex-col pt-8">
        <div class="px-6 mb-8 flex items-center gap-2">
            <div class="w-7 h-7 bg-[#5c67f2] rounded shadow-sm flex items-center justify-center text-white font-bold">‚úì</div>
            <span class="font-bold text-gray-700">Task</span>
        </div>
        <nav class="px-3 space-y-1">
            <button onclick="switchTab('today')" id="tab-today" class="sidebar-item active w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm">
                <span>üìÖ</span> Today
            </button>
            <button onclick="switchTab('tomorrow')" id="tab-tomorrow" class="sidebar-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm text-gray-500 hover:bg-gray-100">
                <span>üìÖ</span> Tomorrow
            </button>
        </nav>
    </aside>

    <main class="flex-1 p-8 max-w-3xl mx-auto">
        <h2 id="view-title" class="text-2xl font-bold mb-6 text-gray-800">Today</h2>

        <div class="input-container mb-8 rounded-xl p-1 flex items-center shadow-sm">
            <span class="px-3 text-gray-400 text-xl font-light">+</span>
            <input type="text" id="task-input" placeholder="Add task" class="flex-1 bg-transparent py-2 outline-none text-sm text-gray-600">
            <div class="flex items-center gap-2 pr-2">
                <select id="priority-input" class="bg-transparent text-sm outline-none cursor-pointer">
                    <option value="4">‚ö™ None</option>
                    <option value="1">üî¥ High</option>
                    <option value="2">üü° Medium</option>
                    <option value="3">üîµ Low</option>
                </select>
                <button onclick="addTask()" class="bg-[#5c67f2] text-white text-[11px] font-bold px-3 py-1 rounded-lg">+</button>
            </div>
        </div>

        <div id="active-tasks" class="space-y-1 mb-8"></div>

        <div id="completed-container" class="mt-8 border-t border-gray-100 pt-4 hidden">
            <div class="completed-section-header flex items-center gap-2 text-gray-400 text-sm font-medium mb-4" onclick="toggleCompletedList()">
                <span id="chevron">‚åÑ</span> Completed <span id="completed-count" class="ml-1">0</span>
            </div>
            <div id="completed-tasks" class="space-y-1"></div>
        </div>
    </main>

    <script>
        const SB_URL = 'https://cyfchiajwmbnlptibpxd.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5ZmNoaWFqd21ibmxwdGlicHhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NjAwMTgsImV4cCI6MjA4MzQzNjAxOH0.ax5y3HpY6rE0IgKyXkd1VU3oDdnH3N0YDNwXDBBZy5g'; 
        const client = supabase.createClient(SB_URL, SB_KEY);

        let allTasks = [];
        let currentTab = 'today';
        let showCompleted = true;

        const getFormattedDate = (offset = 0) => {
            const d = new Date(); d.setDate(d.getDate() + offset);
            return d.toISOString().split('T')[0];
        };

        async function fetchTasks() {
            const { data, error } = await client.from('tasks').select('*').order('priority', { ascending: true });
            if (!error) { allTasks = data || []; render(); }
        }

        async function addTask() {
            const input = document.getElementById('task-input');
            if (!input.value) return;
            const targetDate = currentTab === 'today' ? getFormattedDate(0) : getFormattedDate(1);
            await client.from('tasks').insert([{ 
                text: input.value, 
                priority: parseInt(document.getElementById('priority-input').value),
                task_date: targetDate,
                category: 'Other'
            }]);
            input.value = '';
            fetchTasks();
        }

        async function toggleTask(id, status) {
            await client.from('tasks').update({ completed: !status }).eq('id', id);
            fetchTasks();
        }

        async function deleteTask(id) {
            if(confirm('Delete?')) { await client.from('tasks').delete().eq('id', id); fetchTasks(); }
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('view-title').innerText = tab === 'today' ? 'Today' : 'Tomorrow';
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            render();
        }

        function toggleCompletedList() {
            showCompleted = !showCompleted;
            document.getElementById('completed-tasks').classList.toggle('hidden');
            document.getElementById('chevron').innerText = showCompleted ? '‚åÑ' : '‚Ä∫';
        }

        function render() {
            const activeEl = document.getElementById('active-tasks');
            const completedEl = document.getElementById('completed-tasks');
            const todayStr = getFormattedDate(0);
            const tomorrowStr = getFormattedDate(1);

            const currentTasks = allTasks.filter(t => {
                if (currentTab === 'today') return t.task_date <= todayStr;
                return t.task_date === tomorrowStr;
            });

            const active = currentTasks.filter(t => !t.completed);
            const completed = currentTasks.filter(t => t.completed);

            const taskMapper = t => `
                <div class="group flex items-center justify-between py-2 px-2 hover:bg-gray-50 rounded-lg transition border-b border-gray-50 last:border-0">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" ${t.completed ? 'checked' : ''} 
                            onchange="toggleTask(${t.id}, ${t.completed})" 
                            class="cb-custom cb-p${t.priority}">
                        <span class="text-sm task-text ${t.completed ? 'completed' : 'text-gray-700'}">${t.text}</span>
                    </div>
                    <button onclick="deleteTask(${t.id})" class="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-400 px-2 transition">‚úï</button>
                </div>
            `;

            activeEl.innerHTML = active.map(taskMapper).join('');
            completedEl.innerHTML = completed.map(taskMapper).join('');
            
            // X·ª≠ l√Ω khu v·ª±c Completed
            document.getElementById('completed-count').innerText = completed.length;
            document.getElementById('completed-container').style.display = completed.length > 0 ? 'block' : 'none';
        }

        window.onload = fetchTasks;
    </script>
</body>
</html>
