<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>0.1% Discipline Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; color: #1f2937; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .score-header { position: fixed; top: 0; left: 0; right: 0; height: 80px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1000; border-bottom: 1px solid #e5e7eb; padding-top: env(safe-area-inset-top); }
        
        .cb-custom { width: 26px; height: 26px; border-radius: 50%; border: 3px solid; appearance: none; position: relative; cursor: pointer; flex-shrink: 0; transition: 0.2s; }
        .cb-custom::after { content: '‚úì'; color: white; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 14px; font-weight: bold; opacity: 0; }
        .cb-custom:checked::after { opacity: 1; }
        .cb-p1 { border-color: #ef4444; } .cb-p1:checked { background-color: #ef4444; }
        .cb-p2 { border-color: #fb923c; } .cb-p2:checked { background-color: #fb923c; }
        .cb-p3 { border-color: #60a5fa; } .cb-p3:checked { background-color: #60a5fa; }
        .cb-p4 { border-color: #9ca3af; } .cb-p4:checked { background-color: #9ca3af; }

        main { padding: 100px 16px 110px 16px; max-width: 600px; margin: 0 auto; }
        .add-btn-floating { position: fixed; bottom: 90px; left: 20px; width: 56px; height: 56px; background: #4f46e5; border-radius: 18px; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4); z-index: 1001; }
        
        #autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 3000; max-height: 200px; overflow-y: auto; display: none; margin-top: 5px; border: 1px solid #f3f4f6; }
        .suggestion-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f9fafb; font-weight: 500; }
        .suggestion-item:hover { background-color: #f3f4f6; }

        /* Swipe to Delete v2 */
        .task-wrapper { position: relative; overflow: hidden; border-radius: 1rem; margin-bottom: 0.75rem; touch-action: pan-y; }
        .task-content { position: relative; transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); z-index: 2; background: white; }
        .delete-action { position: absolute; right: 0; top: 0; bottom: 0; width: 80px; background: #ef4444; color: white; display: flex; align-items: center; justify-content: center; z-index: 1; border-radius: 0 1rem 1rem 0; cursor: pointer; font-size: 1.2rem; }

        .priority-popover { position: absolute; right: 0; top: 40px; background: white; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; padding: 12px; flex-direction: column; gap: 12px; z-index: 2000; border: 1px solid #f3f4f6; }
        .priority-popover.active { display: flex; }
    </style>
</head>
<body onclick="handleClickOutside(event)">

    <header class="score-header">
        <div class="flex items-center gap-3">
            <div id="medal-container" class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center border border-indigo-100"><i class="fas fa-medal text-indigo-400"></i></div>
            <div>
                <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest leading-tight">Discipline Score</p>
                <h1 id="total-score" class="text-2xl font-extrabold text-gray-800 leading-none">0</h1>
            </div>
        </div>
        <div class="text-right"><p id="rank-title" class="text-[10px] font-bold text-indigo-500 bg-indigo-50 px-2 py-1 rounded-full uppercase">ƒêANG T√çNH...</p></div>
    </header>

    <main>
        <div id="task-view">
            <h2 id="tab-title" class="text-[11px] font-black text-gray-400 uppercase tracking-widest mb-4 ml-1">H√îM NAY</h2>
            
            <div id="inline-add-container" class="mb-3 hidden" onclick="event.stopPropagation()">
                <div class="bg-white p-4 rounded-2xl border-2 border-indigo-100 flex items-center gap-4 shadow-sm relative">
                    <div class="w-[26px] h-[26px] rounded-full border-2 border-gray-300 flex-shrink-0"></div>
                    <div class="flex-1 relative">
                        <input type="text" id="inline-task-input" class="w-full text-lg font-semibold outline-none bg-transparent" placeholder="Nhi·ªám v·ª• m·ªõi..." onkeydown="handleInlineKey(event)" oninput="handleAutocomplete(event)">
                        <div id="autocomplete-list"></div>
                    </div>
                    <div class="relative flex-shrink-0">
                        <button id="p-select-btn" onclick="togglePriorityMenu(event)" class="text-2xl leading-none">‚ö™</button>
                        <div id="priority-menu" class="priority-popover">
                            <button onclick="setInlinePriority(1)">üî¥</button>
                            <button onclick="setInlinePriority(2)">üü°</button>
                            <button onclick="setInlinePriority(3)">üîµ</button>
                            <button onclick="setInlinePriority(4)">‚ö™</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="active-tasks" class="space-y-1"></div>
            <details class="mt-8 group" id="completed-section">
                <summary class="flex items-center gap-2 text-gray-400 font-bold text-xs cursor-pointer list-none bg-gray-100/50 p-3 rounded-xl select-none">
                    <i class="fas fa-chevron-right transition-transform group-open:rotate-90 text-[10px]"></i>
                    <span>ƒê√É XONG (<span id="completed-count">0</span>)</span>
                </summary>
                <div id="completed-tasks" class="mt-4 space-y-1 opacity-60"></div>
            </details>
        </div>
    </main>

    <button id="add-trigger-btn" onclick="showInlineAdd(event)" class="add-btn-floating"><i class="fas fa-plus"></i></button>

    <nav class="bottom-nav">
        <button onclick="switchTab('today')" id="btn-today" class="nav-item active flex flex-col items-center"><i class="fas fa-calendar-check text-lg"></i><span class="text-[9px] font-bold mt-1 uppercase">Today</span></button>
        <button onclick="switchTab('tomorrow')" id="btn-tomorrow" class="nav-item flex flex-col items-center"><i class="fas fa-calendar-plus text-lg"></i><span class="text-[9px] font-bold mt-1 uppercase">Next</span></button>
        <button onclick="switchTab('achievements')" id="btn-achievements" class="nav-item flex flex-col items-center"><i class="fas fa-award text-lg"></i><span class="text-[9px] font-bold mt-1 uppercase">Ranks</span></button>
    </nav>

    <script>
        const SB_URL = 'https://cyfchiajwmbnlptibpxd.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5ZmNoaWFqd21ibmxwdGlicHhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NjAwMTgsImV4cCI6MjA4MzQzNjAxOH0.ax5y3HpY6rE0IgKyXkd1VU3oDdnH3N0YDNwXDBBZy5g';
        const client = supabase.createClient(SB_URL, SB_KEY);

        let allTasks = [];
        let currentTab = 'today';
        let tempPriority = 4;
        let startX = 0;
        let activeSwipeId = null;

        function getLocalYYYYMMDD(offsetDays = 0) {
            const now = new Date();
            const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000));
            if (offsetDays !== 0) localDate.setDate(localDate.getDate() + offsetDays);
            return localDate.toISOString().split('T')[0];
        }

        function showInlineAdd(e) {
            e.stopPropagation();
            document.getElementById('inline-add-container').classList.remove('hidden');
            document.getElementById('inline-task-input').focus();
            tempPriority = 4;
            document.getElementById('p-select-btn').innerText = '‚ö™';
        }

        function handleAutocomplete(e) {
            const val = e.target.value.trim().toLowerCase();
            const list = document.getElementById('autocomplete-list');
            if (!val) { list.style.display = 'none'; return; }
            const suggestions = [...new Set(allTasks.map(t => t.text))].filter(t => t.toLowerCase().includes(val)).slice(0, 5);
            if (suggestions.length) {
                list.innerHTML = suggestions.map(s => `<div class="suggestion-item" onclick="selectAndSaveSuggestion('${s.replace(/'/g, "\\'")}')">${s}</div>`).join('');
                list.style.display = 'block';
            } else { list.style.display = 'none'; }
        }

        async function selectAndSaveSuggestion(val) {
            document.getElementById('inline-task-input').value = val;
            document.getElementById('autocomplete-list').style.display = 'none';
            await saveInlineTask();
        }

        function togglePriorityMenu(e) { e.stopPropagation(); document.getElementById('priority-menu').classList.toggle('active'); }
        async function setInlinePriority(p) { tempPriority = p; await saveInlineTask(); }

        async function saveInlineTask() {
            const input = document.getElementById('inline-task-input');
            const text = input.value.trim();
            if (!text) { document.getElementById('inline-add-container').classList.add('hidden'); return; }
            const targetDate = (currentTab === 'tomorrow') ? getLocalYYYYMMDD(1) : getLocalYYYYMMDD(0);
            await client.from('tasks').insert([{ text, priority: tempPriority, task_date: targetDate, streak: 0 }]);
            input.value = '';
            document.getElementById('inline-add-container').classList.add('hidden');
            document.getElementById('autocomplete-list').style.display = 'none';
            fetchTasks();
        }

        function handleInlineKey(e) { if (e.key === 'Enter') saveInlineTask(); }
        function handleClickOutside(e) { 
            const container = document.getElementById('inline-add-container');
            if (!container.classList.contains('hidden') && !e.target.closest('#inline-add-container')) saveInlineTask();
            if (activeSwipeId) closeAllSwipes();
        }

        async function fetchTasks() {
            const { data } = await client.from('tasks').select('*');
            allTasks = data || [];
            updateHeader();
            render();
        }

        function updateHeader() {
            const today = getLocalYYYYMMDD(0);
            const totalScore = allTasks.reduce((sum, t) => {
                const p = {1:4, 2:3, 3:2, 4:1}[t.priority || 4] * Math.pow(1.001, t.streak || 0);
                return t.completed ? sum + p : (t.task_date < today ? sum - p : sum);
            }, 0);
            document.getElementById('total-score').innerText = totalScore.toFixed(2);
        }

        // --- IMPROVED SWIPE LOGIC ---
        function closeAllSwipes() {
            document.querySelectorAll('.task-content').forEach(el => el.style.transform = 'translateX(0px)');
            activeSwipeId = null;
        }

        function handleTouchStart(e, id) {
            if (activeSwipeId && activeSwipeId !== id) closeAllSwipes();
            startX = e.touches[0].clientX;
        }

        function handleTouchMove(e, id) {
            const diff = startX - e.touches[0].clientX;
            const content = document.getElementById(`task-content-${id}`);
            if (diff > 10) {
                activeSwipeId = id;
                const move = Math.min(diff, 100);
                content.style.transform = `translateX(-${move}px)`;
            }
        }

        function handleTouchEnd(e, id) {
            const content = document.getElementById(`task-content-${id}`);
            const diff = startX - e.changedTouches[0].clientX;
            if (diff > 30) content.style.transform = `translateX(-80px)`;
            else { content.style.transform = `translateX(0px)`; activeSwipeId = null; }
        }

        async function toggleTask(id, status, priority, streak) {
            const isChecking = !status;
            await client.from('tasks').update({ completed: isChecking, streak: isChecking ? (streak || 0) + 1 : streak, last_completed_at: isChecking ? getLocalYYYYMMDD(0) : null }).eq('id', id);
            fetchTasks();
        }

        function render() {
            const activeDiv = document.getElementById('active-tasks');
            const completedDiv = document.getElementById('completed-tasks');
            const today = getLocalYYYYMMDD(0);
            let filtered = allTasks.filter(t => currentTab === 'today' ? t.task_date <= today : t.task_date === getLocalYYYYMMDD(1));
            filtered.sort((a, b) => a.priority - b.priority);

            const itemHTML = t => `
                <div class="task-wrapper">
                    <div class="delete-action" onclick="deleteTask(${t.id})"><i class="fas fa-trash"></i></div>
                    <div id="task-content-${t.id}" class="task-content bg-white p-4 rounded-2xl border border-gray-100 flex items-center justify-between shadow-sm"
                         ontouchstart="handleTouchStart(event, ${t.id})" ontouchmove="handleTouchMove(event, ${t.id})" ontouchend="handleTouchEnd(event, ${t.id})">
                        <div class="flex items-center gap-4 flex-1">
                            <input type="checkbox" ${t.completed ? 'checked' : ''} onclick="toggleTask(${t.id}, ${t.completed}, ${t.priority}, ${t.streak})" class="cb-custom cb-p${t.priority}">
                            <div class="flex flex-col">
                                <span class="text-lg font-semibold ${t.completed ? 'line-through text-gray-300' : 'text-gray-700'}">${t.text}</span>
                                ${t.task_date < today && !t.completed ? '<span class="text-[10px] font-bold text-red-500">H√¥m qua</span>' : ''}
                            </div>
                        </div>
                        ${t.streak > 0 ? `<span class="text-sm font-black text-gray-300 ml-4">${t.streak}</span>` : ''}
                    </div>
                </div>`;

            activeDiv.innerHTML = filtered.filter(t => !t.completed).map(itemHTML).join('') || '<p class="text-center text-gray-400 text-xs py-10">H·∫øt vi·ªác r·ªìi!</p>';
            completedDiv.innerHTML = filtered.filter(t => t.completed).map(itemHTML).join('');
            document.getElementById('completed-count').innerText = filtered.filter(t => t.completed).length;
        }

        async function deleteTask(id) { await client.from('tasks').delete().eq('id', id); fetchTasks(); }
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('btn-' + tab).classList.add('active');
            fetchTasks();
        }

        window.onload = async () => { await fetchTasks(); };
    </script>
</body>
</html>
