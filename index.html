<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=overlays-content">

<title>0.1% Discipline Pro</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
html, body { height: 100%; }

body {
    font-family: 'Inter', sans-serif;
    background-color: #f9fafb;
    color: #1f2937;
    -webkit-tap-highlight-color: transparent;
    overflow: hidden;
}

.score-header {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: calc(45px + env(safe-area-inset-top));
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    padding: 0 20px 8px;
    z-index: 1000;
    border-bottom: 1px solid #e5e7eb;
}

main {
    position: absolute;
    top: calc(45px + env(safe-area-inset-top));
    bottom: calc(50px + env(safe-area-inset-bottom));
    left: 0; right: 0;
    overflow-y: auto;
    padding: 15px 16px;
    -webkit-overflow-scrolling: touch;
}

.bottom-nav {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    height: calc(50px + env(safe-area-inset-bottom));
    background: white;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: center;
    align-items: center;
    padding-bottom: env(safe-area-inset-bottom);
    z-index: 9999;
}

.nav-item {
    color: #8E8E93;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: color .2s ease;
    flex: 1;
    height: 44px;
    background: none;
    border: none;
}

.nav-item.active { color: #007AFF !important; }

.add-btn-floating {
    position: fixed;
    bottom: calc(70px + env(safe-area-inset-bottom));
    left: 20px;
    width: 56px; height: 56px;
    background: #007AFF;
    border-radius: 50%;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    z-index: 10001;
    transition: transform .2s;
}

.add-btn-floating:active { transform: scale(.88); }

.floating-point {
    position: fixed;
    font-weight: 900;
    pointer-events: none;
    font-size: 3rem;
    opacity: 0;
    z-index: 10002;
    transition: transform .8s cubic-bezier(.22,1,.36,1), opacity .4s;
}

.task-checkbox {
    appearance: none;
    width: 22px; height: 22px;
    border: 2px solid;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.task-checkbox:checked {
    background-color: currentColor;
}

.task-checkbox:checked::after {
    content: "\f00c";
    font-family: "Font Awesome 6 Free";
    font-weight: 900;
    color: white;
    font-size: 12px;
}
</style>
</head>

<body>

<header class="score-header">
    <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center border">
            <i class="fas fa-medal text-indigo-400"></i>
        </div>
        <div>
            <p class="text-[9px] font-bold text-gray-400 uppercase">Discipline Score</p>
            <h1 id="total-score" class="text-2xl font-extrabold">0</h1>
        </div>
    </div>
    <p id="rank-title" class="text-[10px] font-bold text-indigo-500 bg-indigo-50 px-2 py-1 rounded-full uppercase">ĐANG TÍNH...</p>
</header>

<main>
<div id="task-view">
<h2 id="tab-title" class="text-[11px] font-black text-gray-400 uppercase mb-4">HÔM NAY</h2>

<div id="inline-add-container" class="mb-3 hidden">
<div id="inline-card" class="bg-white p-4 rounded-2xl border-2 border-indigo-200 flex gap-4 shadow-md relative">
    <div class="w-[22px] h-[22px] rounded-full border-2"></div>
    <div class="flex-1 relative">
        <input id="inline-task-input"
               class="w-full text-lg font-semibold outline-none bg-transparent"
               placeholder="Add Task"
               autocomplete="off"
               oninput="handleInputSearch(this.value)"
               onkeydown="handleInlineKey(event)">
        <div id="custom-suggestions"
             class="absolute left-0 right-0 top-full mt-2 bg-white rounded-xl shadow-xl hidden z-[1002]"></div>
    </div>
</div>
</div>

<div id="active-tasks"></div>
</div>
</main>

<button onclick="showInlineAdd()" class="add-btn-floating">
<i class="fas fa-plus"></i>
</button>

<nav class="bottom-nav">
<button onclick="switchTab('today')" id="btn-today" class="nav-item active">
<i class="fas fa-calendar-check"></i><span class="text-[9px]">Today</span>
</button>
<button onclick="switchTab('tomorrow')" id="btn-tomorrow" class="nav-item">
<i class="fas fa-calendar-plus"></i><span class="text-[9px]">Next</span>
</button>
<button onclick="switchTab('achievements')" id="btn-achievements" class="nav-item">
<i class="fas fa-award"></i><span class="text-[9px]">Ranks</span>
</button>
</nav>

<script>
const SB_URL = 'https://cyfchiajwmbnlptibpxd.supabase.co';
const SB_KEY = 'ANON_KEY_ONLY';
const client = supabase.createClient(SB_URL, SB_KEY);

let allTasks = [];
let currentTab = 'today';

function getLocalYYYYMMDD(offset = 0) {
    const d = new Date();
    d.setDate(d.getDate() + offset);
    return d.getFullYear() + '-' +
        String(d.getMonth() + 1).padStart(2, '0') + '-' +
        String(d.getDate()).padStart(2, '0');
}

function parseLocalDateYMD(s) {
    if (!s) return null;
    const [y,m,d] = s.split('-').map(Number);
    return new Date(y, m-1, d);
}

function calculatePoints(priority, streak) {
    const base = {1:4,2:3,3:2,4:1};
    return base[priority||4] * Math.pow(1.001, streak||0);
}

async function fetchTasks() {
    const { data } = await client.from('tasks').select('*');
    allTasks = data || [];
    render();
}

async function runDailySync() {
    const todayStr = getLocalYYYYMMDD();
    const todayDate = parseLocalDateYMD(todayStr);
    const updates = [];

    allTasks.forEach(t => {
        if (!t.completed && t.task_date && t.task_date < todayStr) {
            const diffDays = Math.floor(
                (todayDate - parseLocalDateYMD(t.task_date)) / 86400000
            );
            if (diffDays > 0) {
                updates.push(
                    client.from('tasks')
                        .update({
                            task_date: todayStr,
                            streak: Math.max(0, (t.streak||0) - diffDays),
                            last_completed_at: 'was_delayed'
                        })
                        .eq('id', t.id)
                );
            }
        }
    });

    if (updates.length) {
        await Promise.all(updates);
        fetchTasks();
    }
}

function render() {
    const today = getLocalYYYYMMDD();
    const active = document.getElementById('active-tasks');

    const tasks = allTasks.filter(t =>
        currentTab === 'today'
            ? t.task_date && t.task_date <= today
            : true
    );

    active.innerHTML = tasks.map(t => `
        <div class="bg-white p-4 rounded-xl flex gap-4">
            <input type="checkbox"
                   class="task-checkbox"
                   aria-label="Hoàn thành"
                   ${t.completed?'checked':''}>
            <span>${t.text}</span>
        </div>
    `).join('');
}

function switchTab(ta
